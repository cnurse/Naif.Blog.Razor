@using Naif.Blog.Models
@using Naif.Blog.Services
@using Naif.Core.Models

@inherits MenuComponentBase

@inject IBlogManager _blogManager


<MenuBar Menu="@_menu"></MenuBar>
    
@code {
    private Menu _menu;
    
    [Parameter]
    public Blog Blog { get; set; }
    
    [Parameter]
    public string CssClass { get; set; }
    
    [Parameter]
    public bool IncludeParent { get; set; }

    [Parameter]
    public string PostId { get; set; }

    [Parameter]
    public int Depth { get; set; } = 1;

    protected override void OnParametersSet()
    {
        _menu = new Menu
        {
            CssClass = CssClass,
            Depth = Depth,
            IsActiveCssClass = "active",
            Items = new List<MenuItem>()
        };

        //Include Parent
        if (IncludeParent && Depth == 1 && !string.IsNullOrEmpty(PostId))
        {
            var currentPost = _blogManager.GetPost(Blog.BlogId, p => p.PostType != PostType.Post && p.PostId == PostId);

            if (currentPost != null && !string.IsNullOrEmpty(currentPost.ParentPostId))
            {
                AddParentPost(_menu, currentPost);
            }
        }

        //Add Pages to Menu
        var posts = _blogManager.GetPosts(Blog.BlogId, p => p.PostType != PostType.Post && p.ParentPostId == PostId);
        AddMenuItems(_menu, posts, 1);
    }

    private void AddMenuItems(BaseMenuItem menuItem, IEnumerable<Post> posts, int level)
    {
        foreach(var post in posts)
        {
            var childItem = CreateMenuItem(post);
            menuItem.Items.Add(childItem);

            if (level < Depth)
            {
                var childPosts = _blogManager.GetPosts(Blog.BlogId, p => p.PostType != PostType.Post && p.ParentPostId == post.PostId).ToList();
                if (IncludeParent)
                {
                    childPosts.Insert(0, post);
                }
                AddMenuItems(childItem, childPosts, level + 1);
            }
        }
    }

    private void AddParentPost(BaseMenuItem menuItem, Post currentPost)
    {
        var parentPost = _blogManager.GetPost(Blog.BlogId, p => p.PostType != PostType.Post && p.PostId == currentPost.ParentPostId);
        if (parentPost != null)
        {
            var childItem = CreateMenuItem(parentPost);
            menuItem.Items.Add(childItem);
        }
    }
}