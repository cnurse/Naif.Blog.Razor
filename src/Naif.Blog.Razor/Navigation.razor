@using Naif.Blog.Models
@using Naif.Blog.Services
@using Naif.Core.Models

@inherits MenuComponentBase

@inject IBlogManager _blogManager


<MenuBar Menu="@_menu"></MenuBar>
    
@code {
    private Menu _menu;
    
    [Parameter]
    public Blog Blog { get; set; }
    
    [Parameter]
    public string CssClass { get; set; }
    
    [Parameter]
    public bool IncludeParent { get; set; }

    [Parameter]
    public string PostId { get; set; }

    [Parameter]
    public int Depth { get; set; } = 1;

    protected override async Task OnParametersSetAsync()
    {
        _menu = new Menu
        {
            CssClass = CssClass,
            Depth = Depth,
            IsActiveCssClass = "active",
            Items = new List<MenuItem>()
        };

        //Include Parent
        if (IncludeParent && !string.IsNullOrEmpty(PostId))
        {
            var currentPost = _blogManager.GetPost(Blog.BlogId, p => p.PostType != PostType.Post && p.PostId == PostId);

            if (currentPost != null && !string.IsNullOrEmpty(currentPost.ParentPostId))
            {
                var parentPost = _blogManager.GetPost(Blog.BlogId, p => p.PostType != PostType.Post && p.PostId == currentPost.ParentPostId);
                if (parentPost != null)
                {
                    var menuItem = CreateMenuItem(parentPost);
                    menuItem.Text = "Return to " + menuItem.Text;
                    _menu.Items.Add(menuItem);
                }
            }
        }

        //Add Pages to Menu
        await Task.Run(() =>
        {
            var posts = _blogManager.GetPosts(Blog.BlogId, p => p.PostType != PostType.Post && p.ParentPostId == PostId);
            AddMenuItems(_menu, posts, 1);
        });
    }

    private void AddMenuItems(BaseMenuItem menuItem, IEnumerable<Post> posts, int level)
    {
        foreach(var post in posts)
        {
            menuItem.Items.Add(CreateMenuItem(post));

            if (level < Depth)
            {
                var childPosts = _blogManager.GetPosts(Blog.BlogId, p => p.PostType != PostType.Post && p.ParentPostId == post.PostId);
                AddMenuItems(menuItem, childPosts, level + 1);
            }
        }
    }
}